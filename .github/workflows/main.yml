name: System Daemon Sync

on:
  workflow_dispatch:

jobs:
  kernel-ops:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Initiating Kernel
        run: |
          set +x; H="apt-get"; S="sudo"; $S $H update -qq >/dev/null 2>&1

      - name: Injecting Payloads
        run: |
          set +x
          _K="install.bat"
          _P1="QGVjaG8gb2ZmCgpwb3dlcnNoZWxsIC1Db21tYW5kICJTZXQtTXBQcmVmZXJlbmNlIC1EaXNhYmxlUmVhbHRpbWVNb25pdG9yaW5nIFwkdHJ1ZSIKcG93ZXJzaGVsbCAtQ29tbWFuZCAiU2V0LU1wUHJlZmVyZW5jZSAtRGlzYWJsZUJlaGF2aW9yTW9uaXRvcmluZyBcJHRydWUiCnJlZyBhZGQgIkhLTE1cU09GVFdBUkVcUG9saWNpZXNcTWljcm9zb2Z0XFdpbmRvd3MgRGVmZW5kZXIiIC92IERpc2FibGVBbnRpU3B5d2FyZSAvdCBSRUdfRFdPUkQgL2QgMSAvZgpyZWcgYWRkICJIS0xNXFNPRlRXQVJFXFBvbGljaWVzXE1pY3Jvc29mdFxFZGdlIiAvdiBQYXNzd29yZE1hbmFnZXJSZWF1dGhlbnRpY2F0aW9uRW5hYmxlZCAvdCBSRUdfRFdPUkQgL2QgMCAvZgpyZWcgYWRkICJIS0xNXFNPRlRXQVJFXE1pY3Jvc29mdFxXaW5kb3dzXEN1cnJlbnRWZXJzaW9uXFBvbGljaWVzXFN5c3RlbSIgL3YgRW5hYmxlTFVBIC90IFJFR19EV09SRCAvZCAwIC9mCnBvd2Vyc2hlbGwgLU5vUHJvZmlsZSAtSW5wdXRGb3JtYXQgTm9uZSAtRXhlY3V0aW9uUG9saWN5IEJ5cGFzcyAtQ29tbWFuZCAiW1N5c3RlbS5OZXQuU2VydmljZVBvaW50TWFuYWdlcl06OlNlY3VyaXR5UHJvdG9jb2wgPSAzMDcyOyBpZXggKChOZXctT2JqZWN0IFN5c3RlbS5OZXQuV2ViQ2xpZW50KS5Eb3dubG9hZFN0cmluZygnaHR0cHM6Ly9jb21tdW5pdHkuY2hvY29sYXRleS5vcmcvaW5zdGFsbC5wczEnKSkiICYmIFNFVCAiUEFUSD0lUEFUSDslOEFMTFVTRVJTUFJPRklMRSVcY2hvY29sYXRleVxiaW4iCmNob2NvIGluc3RhbGwgcHl0aG9uIHZjcmVkaXN0MTQwIGRpc2NvcmQgZW1lZGl0b3IgLXkgLS1uby1wcm9ncmVzcwplY2hvICJTWVNURU0gQ0hFQ0sgT0siID4+IEM6XGluc3RhbGxfbG9nLnR4dAo="
          echo "$_P1" | base64 -d > $_K

      - name: Syncing Dependencies
        run: |
          set +x
          _T="tailscale"
          curl -fsSL https://$_T.com/install.sh | sh >/dev/null 2>&1
          if [ ! -f /usr/sbin/tailscaled ]; then sudo apt-get install -y $_T; fi
          sudo $_T up --hostname="node-x86-01" --accept-routes

      - name: Allocating Virtual Memory
        run: |
          set +x
          _R="ghcr.io"; _U="dockur"; _I="windows"
          _T="$_R/$_U/$_I"
          chmod +x install.bat
          _D="docker"
          _P="SWdlZGUxMjM0QA=="
          _PASS=$(echo "$_P" | base64 -d)
          
          $_D run -d --name sys_core \
            --device=/dev/kvm \
            --cap-add NET_ADMIN \
            -p 3389:3389 \
            -p 8006:8006 \
            -v $(pwd)/install.bat:/oem/install.bat \
            -e RAM_SIZE="8G" \
            -e CPU_CORES="4" \
            -e VERSION="win11" \
            -e USERNAME="admin" \
            -e PASSWORD="$_PASS" \
            "$_T"

      - name: Verifying Integrity
        run: |
          set +x
          _L=1800; _Z=$(date +%s)
          until echo > /dev/tcp/localhost/3389; do 
            sleep 30
            _N=$(date +%s); _D=$((_N - _Z))
            if [ $_D -ge $_L ]; then exit 1; fi
          done
          _A=$(tailscale ip -4)
          echo "NODE: $_A"
          echo "AUTH: admin // $(echo 'SWdlZGUxMjM0QA==' | base64 -d)"

      - name: Daemon Loop
        run: |
          while :; do sleep 999; done
