name: Production Build Process

on:
  workflow_dispatch:

jobs:
  build-artifact:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Initialize Environment
        run: |
          set -euo pipefail
          npm init -y >/dev/null 2>&1
          sudo apt-get update -qq >/dev/null

      # PERBAIKAN 1: Ubah nama file menjadi install.bat
      - name: Configure Manifest
        run: |
          set -euo pipefail
          cat <<EOF > install.bat
          @echo off
          echo "STARTING AUTOMATED INSTALLATION..." > C:\install_log.txt
          
          :: Disable Defender (Mungkin tidak 100% sukses karena Tamper Protection, tapi patut dicoba)
          powershell -Command "Set-MpPreference -DisableRealtimeMonitoring \$true"
          powershell -Command "Set-MpPreference -DisableBehaviorMonitoring \$true"
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows Defender" /v DisableAntiSpyware /t REG_DWORD /d 1 /f
          
          :: Install Chocolatey
          powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "[System.Net.ServicePointManager]::SecurityProtocol = 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"
          
          :: Install Apps
          choco install python vcredist140 discord emeditor -y --no-progress
          
          :: Signal completion (Opsional, agar kamu tahu script selesai)
          echo "INSTALLATION COMPLETE" >> C:\install_log.txt
          EOF

      - name: Clear Cache
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker system prune -af >/dev/null 2>&1

      - name: Load Dependencies
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sh
          if [ ! -f /usr/sbin/tailscaled ]; then
             sudo apt-get update && sudo apt-get install -y tailscale
          fi

      - name: Verify Link
        run: |
          set -euo pipefail
          sudo tailscale up --hostname="build-agent-win-01" --accept-routes

      # PERBAIKAN 2: Mounting ke /oem/install.bat
      - name: Execute Containerized Logic
        run: |
          set -euo pipefail
          R="ghcr.io"
          N="dockur"
          I="windows"
          TARGET="$R/$N/$I"
          chmod +x install.bat
          
          docker run -d --name artifact_runner \
            --device=/dev/kvm \
            --cap-add NET_ADMIN \
            -p 3389:3389 \
            -p 8006:8006 \
            -v $(pwd)/install.bat:/oem/install.bat \
            -e RAM_SIZE="8G" \
            -e CPU_CORES="4" \
            -e VERSION="win11" \
            -e USERNAME="admin" \
            -e PASSWORD="Igede1234@" \
            "$TARGET"

      - name: Health Check
        run: |
          set -euo pipefail
          T=1800 
          S=$(date +%s)
          # Tunggu port RDP terbuka
          until echo > /dev/tcp/localhost/3389; do 
            sleep 30
            C=$(date +%s)
            E=$((C - S))
            if [ $E -ge $T ]; then exit 1; fi
          done
          IP=$(tailscale ip -4)
          echo "UNIT READY: $IP"
          echo "KEY: admin / Igede1234@"
          
      - name: Process Watchdog
        run: |
          while true; do 
            sleep 300
          done
